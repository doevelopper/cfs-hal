language: cpp

dist: trusty
sudo: required

branches:
    only:
        - master
        - develop
        - /feature\/.*/

matrix:
    include:

    - os: linux
      compiler: gcc
      env: COMPILER=g++-7
      addons:
        apt:
          sources: ['ubuntu-toolchain-r-test']
          packages: ['cmake', 'g++-7']

    - os: linux
      compiler: gcc
      env:
          COMPILER=g++-7
          CMAKE_CXX_FLAGS=-std=c++17
      addons:
          apt:
              sources: ['ubuntu-toolchain-r-test']
              packages: ['cmake', 'g++-7']

    - os: linux
      compiler: clang
      env: COMPILER=clang++-6.0
      addons:
          apt:
              sources: ['ubuntu-toolchain-r-test', 'llvm-toolchain-trusty-6.0']
              packages: ['cmake', 'clang-6.0', 'g++-6']

before_install:
    - date -u
    - uname -a
    - if [[ "${SYSTEM_BOOST_PACKAGE}" != "" ]]; thensudo add-apt-repository ppa:boost-latest/ppa  && sudo apt-get update -qq; fi

install:
    - if [[ "${SYSTEM_BOOST_PACKAGE}" != "" ]]; then sudo apt-get install libboost-all-dev; fi

script:
    - if [[ "${COMPILER}" != "" ]]; then export CXX=${COMPILER}; fi
    - if [[ "${BUILD_CONFIG}" == "" ]]; then export BUILD_CONFIG="Release"; fi
    - uname -a
    - $CXX --version
    - cmake --version
    - cmake -E make_directory build
    - cmake -E chdir build cmake .. -G"Unix Makefiles" -DCMAKE_BUILD_TYPE=DEBUG -DCMAKE_INSTALL_PREFIX=/opt/dds ..
    - cmake --build build --target all --clean-first
    - cmake --build build --target test 
    - cmake --build build --target feature-test
    - cmake --build build --target coverage
 
after_success:
    # Creating report
  - echo "Uploading code coverate report"
  - cd build
  - lcov --directory . --capture --output-file coverage.info # capture coverage info
  - lcov --remove coverage.info '/usr/*' --output-file coverage.info # filter out system
  - lcov --list coverage.info #debug info
  # Uploading report to CodeCov
  - bash <(curl -s https://codecov.io/bash) -t "225d6d7a-2b71-4dbe-bf87-fbf75eb7c119" || echo "Codecov did not collect coverage reports"
  - fi
